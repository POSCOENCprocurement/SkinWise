<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinWise AI - 피부 분석</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: Pretendard, sans-serif; }
        
        /* Animation Utilities */
        .animate-in { animation-duration: 0.5s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; }
        .slide-in-from-bottom-4 { animation-name: slideUp4; }
        .slide-in-from-bottom-8 { animation-name: slideUp8; }
        .zoom-in-95 { animation-name: zoomIn95; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp4 { from { transform: translateY(1rem); } to { transform: translateY(0); } }
        @keyframes slideUp8 { from { transform: translateY(2rem); } to { transform: translateY(0); } }
        @keyframes zoomIn95 { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useRef, useEffect, useMemo } = React;

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Camera = (props) => (
            <IconBase {...props}>
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
            </IconBase>
        );

        const Upload = (props) => (
            <IconBase {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </IconBase>
        );

        const Sparkles = (props) => (
            <IconBase {...props}>
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/>
            </IconBase>
        );

        const User = (props) => (
            <IconBase {...props}>
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </IconBase>
        );

        const ArrowRight = (props) => (
            <IconBase {...props}>
                <line x1="5" y1="12" x2="19" y2="12"/>
                <polyline points="12 5 19 12 12 19"/>
            </IconBase>
        );

        const XIcon = (props) => (
            <IconBase {...props}>
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </IconBase>
        );

        const Check = (props) => (
            <IconBase {...props}>
                <polyline points="20 6 9 17 4 12"/>
            </IconBase>
        );

        const AlertCircle = (props) => (
            <IconBase {...props}>
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </IconBase>
        );

        const Search = (props) => (
            <IconBase {...props}>
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </IconBase>
        );

        const ShoppingBag = (props) => (
            <IconBase {...props}>
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <path d="M16 10a4 4 0 0 1-8 0"/>
            </IconBase>
        );

        const Beaker = (props) => (
            <IconBase {...props}>
                <path d="M4.5 3h15"/>
                <path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/>
                <path d="M6 14h12"/>
            </IconBase>
        );

        const Palette = (props) => (
            <IconBase {...props}>
                <circle cx="13.5" cy="6.5" r=".5"/>
                <circle cx="17.5" cy="10.5" r=".5"/>
                <circle cx="8.5" cy="7.5" r=".5"/>
                <circle cx="6.5" cy="12.5" r=".5"/>
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>
            </IconBase>
        );

        // --- Analysis Logic ---
        
        // Pseudo-random number generator seeded by string
        const createSeededRandom = (seedStr) => {
            let hash = 0;
            if (seedStr.length === 0) return () => Math.random();
            // Sample string to make hashing faster
            for (let i = 0; i < seedStr.length; i += 100) {
                const char = seedStr.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            let seed = Math.abs(hash);
            
            // Linear Congruential Generator
            return () => {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
        };

        const analyzeSkin = async (imageData, gender) => {
            // Seed the random generator with the image data for consistent results
            const rng = createSeededRandom(imageData);
            const range = (min, max) => Math.floor(rng() * (max - min) + min);

            return new Promise((resolve) => {
                setTimeout(() => {
                    const details = [
                        { name: "수분도", value: range(30, 95) },
                        { name: "모공", value: range(20, 90) }, 
                        { name: "주름", value: range(40, 95) }, 
                        { name: "잡티/색소", value: range(30, 90) },
                        { name: "탄력", value: range(40, 95) }
                    ].map(item => {
                        let status = "보통";
                        let color = "bg-yellow-500";
                        if (item.value >= 80) { status = "좋음"; color = "bg-green-500"; }
                        else if (item.value < 50) { status = "주의"; color = "bg-red-500"; }
                        return { ...item, status, color };
                    });

                    const totalScore = Math.floor(details.reduce((acc, curr) => acc + curr.value, 0) / details.length);
                    const sortedDetails = [...details].sort((a, b) => a.value - b.value);
                    
                    // Changed to slice 3 items instead of 2
                    const worstThree = sortedDetails.slice(0, 3);
                    
                    // Product Database (Gender Specific)
                    const productDB = {
                        female: {
                            "수분도": { 
                                brand: "토리든 (Torriden)",
                                name: "다이브인 저분자 히알루론산 세럼", 
                                ingredient: "5D 복합 히알루론산, 판테놀",
                                desc: "5가지 크기의 히알루론산이 피부 층층이 수분을 공급하여 속당김을 해결합니다.",
                                query: "토리든 다이브인 세럼" 
                            },
                            "모공": { 
                                brand: "이니스프리 (Innisfree)",
                                name: "화산송이 모공 바하 클렌징 폼", 
                                ingredient: "제주 화산송이, BHA",
                                desc: "강력한 피지 흡착력과 각질 제거 성분으로 모공 속을 깨끗하게 비워줍니다.",
                                query: "이니스프리 화산송이 폼" 
                            },
                            "주름": { 
                                brand: "아이오페 (IOPE)",
                                name: "레티놀 엑스퍼트 0.1%", 
                                ingredient: "순수 레티놀, 히알루론산",
                                desc: "고함량 레티놀이 콜라겐 생성을 촉진하여 미세 주름을 집중 개선합니다.",
                                query: "아이오페 레티놀 엑스퍼트" 
                            },
                            "잡티/색소": { 
                                brand: "구달 (Goodal)",
                                name: "청귤 비타C 잡티 케어 세럼", 
                                ingredient: "청귤 추출물, 비타민C",
                                desc: "비타민C가 멜라닌 생성을 억제하여 2주 만에 맑아지는 피부를 경험하세요.",
                                query: "구달 청귤 비타C 세럼" 
                            },
                            "탄력": { 
                                brand: "닥터지 (Dr.G)",
                                name: "블랙 스네일 크림", 
                                ingredient: "블랙 스네일 점액, 로얄젤리",
                                desc: "영양 가득한 블랙 스네일 성분이 처진 피부를 쫀쫀하고 탄탄하게 리프팅합니다.",
                                query: "닥터지 블랙 스네일 크림" 
                            }
                        },
                        male: {
                            "수분도": { 
                                brand: "라네즈 옴므 (Laneige Homme)",
                                name: "블루 에너지 에센스 인 로션", 
                                ingredient: "해양 심층수, 스피루리나",
                                desc: "스킨+로션 올인원으로, 번들거림 없이 산뜻하게 수분만 충전해주는 제품입니다.",
                                query: "라네즈 옴므 블루 에너지 에센스 인 로션" 
                            },
                            "모공": { 
                                brand: "닥터지 (Dr.G)",
                                name: "레드 블레미쉬 포 맨 올인원", 
                                ingredient: "시카(Cica), 나이아신아마이드",
                                desc: "면도로 민감해진 피부를 진정시키고 넓은 모공과 유분기를 잡아줍니다.",
                                query: "닥터지 레드 블레미쉬 포 맨" 
                            },
                            "주름": { 
                                brand: "우르오스 (UL-OS)",
                                name: "스킨밀크 올인원", 
                                ingredient: "AMP(아데노신 인산), 9가지 허브",
                                desc: "하나만 발라도 하루 종일 촉촉하며, 피부 탄력과 잔주름 개선에 도움을 줍니다.",
                                query: "우르오스 스킨밀크" 
                            },
                            "잡티/색소": { 
                                brand: "아이오페 맨 (IOPE Men)",
                                name: "맨 안티에이징 에멀전", 
                                ingredient: "바이오 리독스, 아데노신",
                                desc: "칙칙한 남성 피부 톤을 밝고 활력 있게 가꾸어주는 기능성 에멀전입니다.",
                                query: "아이오페 맨 안티에이징" 
                            },
                            "탄력": { 
                                brand: "비오템 옴므 (Biotherm Homme)",
                                name: "포스 수프림 유스 아키텍트 세럼", 
                                ingredient: "블루 알개, 프로-자일란",
                                desc: "무너진 피부 구조를 탄탄하게 재건하여 깊은 주름과 탄력 저하를 케어합니다.",
                                query: "비오템 옴므 포스 수프림" 
                            }
                        }
                    };

                    const products = worstThree.map(item => productDB[gender][item.name]);

                    // Personal Color Database
                    const seasons = [
                        {
                            name: "봄 웜톤 (Spring Warm)",
                            desc: "생기 있고 따뜻한 이미지가 돋보입니다.",
                            bestColors: ["#FF7F50", "#FFD700", "#98FB98", "#FA8072"],
                            worstColors: ["#A9A9A9", "#000080", "#8B008B", "#708090"],
                            styling: "파스텔 톤이나 밝은 옐로우 베이스의 컬러가 잘 어울립니다. 골드 액세서리를 추천해요."
                        },
                        {
                            name: "여름 쿨톤 (Summer Cool)",
                            desc: "청량하고 우아한 분위기를 가졌습니다.",
                            bestColors: ["#E6E6FA", "#87CEEB", "#FFB6C1", "#D8BFD8"],
                            worstColors: ["#FF8C00", "#DAA520", "#8B4513", "#556B2F"],
                            styling: "흰끼가 섞인 파스텔 톤이나 그레이시한 컬러가 베스트입니다. 실버 액세서리가 깔끔해요."
                        },
                        {
                            name: "가을 웜톤 (Autumn Warm)",
                            desc: "그윽하고 성숙한 분위기가 매력적입니다.",
                            bestColors: ["#8B4513", "#DAA520", "#556B2F", "#CD853F"],
                            worstColors: ["#FF69B4", "#00FFFF", "#E6E6FA", "#0000FF"],
                            styling: "차분한 어스(Earth) 컬러나 깊이 있는 색감이 잘 어울립니다. 로즈골드나 빈티지 골드를 추천해요."
                        },
                        {
                            name: "겨울 쿨톤 (Winter Cool)",
                            desc: "도시적이고 카리스마 있는 이미지입니다.",
                            bestColors: ["#000000", "#FFFFFF", "#FF0000", "#00008B"],
                            worstColors: ["#DAA520", "#F4A460", "#808000", "#A0522D"],
                            styling: "대비가 확실한 비비드한 컬러나 블랙&화이트가 가장 잘 어울립니다. 화려한 실버 액세서리가 돋보여요."
                        }
                    ];

                    // Select season deterministically
                    const seasonIndex = Math.floor(rng() * 4);
                    const personalColor = seasons[seasonIndex];

                    resolve({
                        score: totalScore,
                        skinType: totalScore > 80 ? "건강한 중성 피부" : (details.find(d => d.name === "수분도")?.value < 50 ? "수분 부족형 지성" : "복합성 피부"),
                        details: details,
                        products: products,
                        personalColor: personalColor
                    });
                }, 2000); 
            });
        };

        // --- Components ---

        const Guidelines = ({ onNext, isLoading, onBack }) => {
            return (
                <div className="max-w-2xl mx-auto bg-white p-8 rounded-3xl shadow-lg space-y-8">
                    <div className="text-center space-y-2">
                        <h3 className="text-2xl font-bold text-slate-900">정확한 분석을 위해</h3>
                        <p className="text-slate-500">다음 사항들을 확인해주세요</p>
                    </div>

                    <div className="space-y-4">
                        <div className="flex items-start gap-4 p-4 bg-indigo-50 rounded-xl">
                            <div className="p-2 bg-indigo-100 text-indigo-600 rounded-full">
                                <Check size={20} />
                            </div>
                            <div>
                                <h4 className="font-bold text-slate-900">메이크업을 지워주세요</h4>
                                <p className="text-sm text-slate-600">정확한 피부 톤과 상태 확인을 위해 민낯 촬영을 권장합니다.</p>
                            </div>
                        </div>
                        <div className="flex items-start gap-4 p-4 bg-indigo-50 rounded-xl">
                            <div className="p-2 bg-indigo-100 text-indigo-600 rounded-full">
                                <Check size={20} />
                            </div>
                            <div>
                                <h4 className="font-bold text-slate-900">밝은 곳에서 촬영하세요</h4>
                                <p className="text-sm text-slate-600">자연광이나 밝은 조명 아래에서 그림자 없이 촬영해주세요.</p>
                            </div>
                        </div>
                        <div className="flex items-start gap-4 p-4 bg-red-50 rounded-xl">
                            <div className="p-2 bg-red-100 text-red-600 rounded-full">
                                <XIcon size={20} />
                            </div>
                            <div>
                                <h4 className="font-bold text-slate-900">필터나 보정은 NO</h4>
                                <p className="text-sm text-slate-600">기본 카메라를 사용하고, 안경이나 마스크를 벗어주세요.</p>
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-3 pt-4">
                         <button 
                            onClick={onBack}
                            disabled={isLoading}
                            className="flex-1 py-4 px-6 rounded-xl font-bold border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors"
                        >
                            이전
                        </button>
                        <button 
                            onClick={onNext}
                            disabled={isLoading}
                            className="flex-[2] bg-indigo-600 text-white py-4 px-6 rounded-xl font-bold hover:bg-indigo-500 shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2"
                        >
                            {isLoading ? (
                                <>
                                    <span className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                                    AI 분석 중...
                                </>
                            ) : (
                                <>
                                    분석 시작하기 <ArrowRight size={20} />
                                </>
                            )}
                        </button>
                    </div>
                </div>
            );
        };

        const SkinAnalysisView = ({ result, image, onReset }) => {
            return (
                <div className="animate-in slide-in-from-bottom-8 fade-in duration-700 space-y-8 pb-20">
                     {/* Summary Card */}
                     <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100">
                        <div className="flex flex-col md:flex-row gap-8 items-center">
                            <div className="w-32 h-32 md:w-40 md:h-40 rounded-full overflow-hidden border-4 border-indigo-100 shadow-inner shrink-0 relative">
                                <img src={image} alt="User" className="w-full h-full object-cover" />
                                <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs text-center py-1">
                                    분석 이미지
                                </div>
                            </div>
                            <div className="text-center md:text-left space-y-2 flex-1">
                                <div className="inline-block px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-bold mb-2">
                                    종합 분석 완료
                                </div>
                                <h2 className="text-3xl font-extrabold text-slate-900">
                                    피부 종합 점수 <span className="text-indigo-600">{result.score}점</span>
                                </h2>
                                <p className="text-lg text-slate-600">
                                    당신의 피부 타입은 <span className="text-slate-900 font-bold decoration-wavy underline decoration-indigo-300">{result.skinType}</span>입니다.
                                </p>
                            </div>
                        </div>
                     </div>

                     {/* Personal Color */}
                     <div className="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                        <div className="relative z-10 space-y-6">
                            <div>
                                <h3 className="flex items-center gap-2 text-lg font-medium opacity-90 mb-1">
                                    <Palette size={20}/> 퍼스널 컬러 진단
                                </h3>
                                <p className="text-3xl font-bold">{result.personalColor.name}</p>
                                <p className="mt-2 text-white/90">{result.personalColor.desc}</p>
                                <p className="mt-1 text-sm text-white/80">{result.personalColor.styling}</p>
                            </div>

                            <div className="grid grid-cols-2 gap-6 bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                                <div>
                                    <p className="text-sm font-bold mb-2 flex items-center gap-1"><Check size={14}/> Best Colors</p>
                                    <div className="flex gap-2">
                                        {result.personalColor.bestColors.map((color, idx) => (
                                            <div key={idx} className="w-8 h-8 rounded-full border-2 border-white/30 shadow-sm" style={{ backgroundColor: color }} title={color}></div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <p className="text-sm font-bold mb-2 flex items-center gap-1 opacity-70"><XIcon size={14}/> Avoid Colors</p>
                                    <div className="flex gap-2">
                                        {result.personalColor.worstColors.map((color, idx) => (
                                            <div key={idx} className="w-8 h-8 rounded-full border-2 border-white/30 shadow-sm opacity-80" style={{ backgroundColor: color }} title={color}></div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <Sparkles className="absolute top-4 right-4 text-white/10 w-40 h-40" />
                     </div>

                     {/* Detail Graph Card */}
                     <div className="bg-white p-6 md:p-8 rounded-3xl shadow-lg border border-slate-100">
                        <h3 className="flex items-center gap-2 text-xl font-bold text-slate-900 mb-6">
                            <Sparkles className="text-indigo-500" /> 상세 항목별 분석
                        </h3>
                        <div className="space-y-6">
                            {result.details.map((item, idx) => (
                                <div key={idx} className="space-y-2">
                                    <div className="flex justify-between items-center text-sm font-medium">
                                        <span className="text-slate-700">{item.name}</span>
                                        <span className={`px-2 py-0.5 rounded text-white text-xs ${item.value >= 80 ? 'bg-green-500' : item.value >= 50 ? 'bg-yellow-500' : 'bg-red-500'}`}>
                                            {item.status} ({item.value}점)
                                        </span>
                                    </div>
                                    <div className="h-4 bg-slate-100 rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full rounded-full transition-all duration-1000 ease-out ${item.value >= 80 ? 'bg-green-400' : item.value >= 50 ? 'bg-yellow-400' : 'bg-red-400'}`} 
                                            style={{ width: `${item.value}%` }} 
                                        />
                                    </div>
                                    <p className="text-xs text-slate-400 text-right">
                                        {item.status === '주의' ? '집중 관리가 필요해요!' : item.status === '좋음' ? '아주 훌륭해요!' : '조금만 더 신경 써주세요.'}
                                    </p>
                                </div>
                            ))}
                        </div>
                     </div>

                     {/* Product Recommendations */}
                     <div className="bg-white p-6 md:p-8 rounded-3xl shadow-lg border border-slate-100">
                        <h3 className="flex items-center gap-2 text-xl font-bold text-slate-900 mb-6">
                            <ShoppingBag className="text-indigo-500" /> AI 맞춤 화장품 추천
                        </h3>
                        <p className="text-slate-500 mb-6 text-sm">
                            현재 피부 상태와 성별을 고려한 최적의 솔루션입니다.
                        </p>
                        <div className="grid gap-4">
                            {result.products.map((product, idx) => (
                                <div key={idx} className="flex flex-col gap-4 p-5 bg-indigo-50/50 border border-indigo-100 rounded-2xl hover:bg-indigo-50 transition-colors">
                                    <div className="flex items-start justify-between gap-4">
                                        <div className="space-y-1.5 flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="bg-white text-indigo-600 border border-indigo-200 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">Solution {idx + 1}</span>
                                                <span className="text-xs font-bold text-indigo-500">{product.brand}</span>
                                            </div>
                                            <h4 className="font-bold text-slate-900 text-lg">{product.name}</h4>
                                            
                                            <div className="mt-3 space-y-2 bg-white/60 p-3 rounded-xl border border-indigo-100/50">
                                                <div className="flex items-start gap-2 text-sm text-slate-700">
                                                    <span className="shrink-0 font-bold bg-indigo-100 text-indigo-700 px-1.5 rounded text-[11px] py-0.5 mt-0.5 flex items-center gap-1">
                                                        <Beaker size={10} /> 성분
                                                    </span>
                                                    <span>{product.ingredient}</span>
                                                </div>
                                                <div className="flex items-start gap-2 text-sm text-slate-600">
                                                    <span className="shrink-0 font-bold bg-green-100 text-green-700 px-1.5 rounded text-[11px] py-0.5 mt-0.5 flex items-center gap-1">
                                                        <Check size={10} /> 효과
                                                    </span>
                                                    <span>{product.desc}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <a 
                                        href={`https://www.google.com/search?q=${encodeURIComponent(product.query)}&tbm=shop`} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="mt-2 flex items-center justify-center gap-2 bg-white border border-slate-200 text-slate-700 py-3 px-5 rounded-xl font-medium hover:text-indigo-600 hover:border-indigo-300 shadow-sm transition-all whitespace-nowrap group"
                                    >
                                        <Search size={16} className="group-hover:scale-110 transition-transform"/>
                                        <span>최저가 검색하기</span>
                                    </a>
                                </div>
                            ))}
                        </div>
                     </div>

                     <div className="flex justify-center pt-8">
                        <button 
                            onClick={onReset}
                            className="bg-slate-900 text-white py-4 px-12 rounded-full font-bold hover:bg-slate-800 shadow-xl transition-transform hover:scale-105 active:scale-95"
                        >
                            새로운 진단 시작하기
                        </button>
                     </div>
                </div>
            )
        }

        // --- Main App Logic ---
        const App = () => {
            const [image, setImage] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [step, setStep] = useState('upload'); // 'upload' | 'guidelines' | 'result'
            const [gender, setGender] = useState('female');
            
            const fileInputRef = useRef(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [isCameraOpen, setIsCameraOpen] = useState(false);

            const startCamera = async () => {
                try {
                    setIsCameraOpen(true);
                    setError(null);
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } 
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    setError('카메라 권한을 얻을 수 없습니다. 브라우저 설정에서 허용해주세요.');
                    setIsCameraOpen(false);
                }
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const context = canvasRef.current.getContext('2d');
                    if (context) {
                        canvasRef.current.width = videoRef.current.videoWidth;
                        canvasRef.current.height = videoRef.current.videoHeight;
                        context.drawImage(videoRef.current, 0, 0);
                        const dataUrl = canvasRef.current.toDataURL('image/jpeg', 0.8);
                        setImage(dataUrl);
                        stopCamera();
                    }
                }
            };

            const stopCamera = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    const stream = videoRef.current.srcObject;
                    stream.getTracks().forEach(track => track.stop());
                    videoRef.current.srcObject = null;
                }
                setIsCameraOpen(false);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
                event.target.value = '';
            };

            const handleAnalyze = async () => {
                if (!image) return;
                
                setIsAnalyzing(true);
                setError(null);
                try {
                    const analysis = await analyzeSkin(image, gender);
                    setResult(analysis);
                    setStep('result');
                } catch (err) {
                    console.error(err);
                    setError(err.message || '분석 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const reset = () => {
                setImage(null);
                setResult(null);
                setStep('upload');
                setError(null);
                stopCamera();
            };

            return (
                <div className="min-h-screen flex flex-col bg-slate-50">
                {/* Header */}
                <header className="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
                    <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={reset}>
                        <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md shadow-indigo-200">
                        <Sparkles size={18} fill="currentColor" />
                        </div>
                        <h1 className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        SkinWise AI
                        </h1>
                    </div>
                    <button className="p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                        <User size={24} />
                    </button>
                    </div>
                </header>

                <main className="flex-1 max-w-4xl w-full mx-auto p-4 md:p-8">
                    {step === 'upload' && (
                    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
                        <div className="text-center space-y-4 pt-8">
                        <h2 className="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900 leading-tight">
                            당신의 피부를<br className="md:hidden" /> <span className="text-indigo-600">더 깊이 이해하세요</span>
                        </h2>
                        <p className="text-slate-500 max-w-lg mx-auto text-lg leading-relaxed">
                            AI 기술을 통해 피부 상태를 정밀 분석하고, 당신에게 꼭 맞는 스킨케어 루틴과 퍼스널 컬러를 찾아드립니다.
                        </p>
                        </div>
                        
                        {/* Gender Selector */}
                        <div className="flex justify-center">
                            <div className="bg-white p-1 rounded-full border border-slate-200 shadow-sm flex">
                                <button 
                                    onClick={() => setGender('female')}
                                    className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${gender === 'female' ? 'bg-pink-100 text-pink-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    여성 (Female)
                                </button>
                                <button 
                                    onClick={() => setGender('male')}
                                    className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${gender === 'male' ? 'bg-blue-100 text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    남성 (Male)
                                </button>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                        {/* Camera Card */}
                        <div 
                            onClick={isCameraOpen ? undefined : startCamera}
                            className={`group relative overflow-hidden bg-white rounded-3xl border-2 transition-all cursor-pointer aspect-[4/5] flex flex-col items-center justify-center gap-6 shadow-sm hover:shadow-xl ${isCameraOpen ? 'border-slate-800' : 'border-slate-100 hover:border-indigo-500'}`}
                        >
                            {!isCameraOpen ? (
                            <>
                                <div className="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-inner">
                                <Camera size={40} />
                                </div>
                                <div className="text-center px-6">
                                <p className="font-bold text-xl text-slate-900 mb-2">셀카 촬영하기</p>
                                <p className="text-slate-500">카메라를 켜고<br/>실시간으로 진단하세요</p>
                                </div>
                            </>
                            ) : (
                            <div className="absolute inset-0 bg-black flex flex-col">
                                <video 
                                ref={videoRef} 
                                autoPlay 
                                playsInline 
                                className="flex-1 w-full object-cover scale-x-[-1]" 
                                />
                                <div className="absolute top-4 right-4 z-10">
                                <button 
                                    onClick={(e) => { e.stopPropagation(); stopCamera(); }}
                                    className="bg-black/50 text-white p-2 rounded-full hover:bg-black/70"
                                >
                                    <XIcon size={24} />
                                </button>
                                </div>
                                <div className="h-24 bg-black/80 flex items-center justify-center gap-8 z-20">
                                    <button 
                                    onClick={(e) => { e.stopPropagation(); stopCamera(); }}
                                    className="text-white font-medium hover:text-white/80"
                                    >
                                    취소
                                    </button>
                                    <button 
                                    onClick={(e) => { e.stopPropagation(); capturePhoto(); }}
                                    className="w-16 h-16 rounded-full border-4 border-white bg-white/20 backdrop-blur-sm transition-transform active:scale-95 hover:bg-white/30" 
                                    />
                                    <div className="w-8" /> {/* spacer */}
                                </div>
                            </div>
                            )}
                        </div>

                        {/* Upload Card */}
                        <div 
                            onClick={() => fileInputRef.current?.click()}
                            className="group bg-white rounded-3xl border-2 border-slate-100 border-dashed hover:border-indigo-500 hover:bg-slate-50 transition-all cursor-pointer aspect-[4/5] flex flex-col items-center justify-center gap-6 shadow-sm hover:shadow-xl"
                        >
                            <div className="w-20 h-20 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-inner">
                            <Upload size={40} />
                            </div>
                            <div className="text-center px-6">
                            <p className="font-bold text-xl text-slate-900 mb-2">사진 업로드</p>
                            <p className="text-slate-500">이미 찍어둔<br/>사진을 선택하세요</p>
                            </div>
                            <input 
                            type="file" 
                            ref={fileInputRef} 
                            onChange={handleFileUpload} 
                            accept="image/*" 
                            className="hidden" 
                            />
                        </div>
                        </div>

                        {image && !isCameraOpen && (
                        <div className="fixed inset-0 z-[60] bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center p-6 space-y-8 animate-in fade-in duration-300">
                            <div className="relative max-w-sm w-full">
                                <img src={image} alt="Preview" className="w-full rounded-3xl shadow-2xl border-2 border-white/20" />
                                <button 
                                onClick={() => setImage(null)}
                                className="absolute -top-4 -right-4 bg-white text-slate-900 p-2 rounded-full shadow-lg hover:scale-110 transition-transform"
                                >
                                <XIcon size={20} />
                                </button>
                            </div>
                            
                            <div className="flex flex-col w-full max-w-sm gap-3">
                            <button 
                                onClick={() => setStep('guidelines')}
                                className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-500 shadow-lg shadow-indigo-600/30 transition-all flex items-center justify-center gap-2 text-lg"
                            >
                                다음 단계로 <ArrowRight size={20} />
                            </button>
                            <button 
                                onClick={() => setImage(null)}
                                className="w-full text-white/70 py-3 font-medium hover:text-white transition-colors"
                            >
                                다시 선택하기
                            </button>
                            </div>
                        </div>
                        )}
                    </div>
                    )}

                    {step === 'guidelines' && (
                    <div className="animate-in fade-in zoom-in-95 duration-500 py-8">
                        <Guidelines onNext={handleAnalyze} isLoading={isAnalyzing} onBack={() => setStep('upload')} />
                    </div>
                    )}

                    {step === 'result' && result && (
                    <SkinAnalysisView result={result} image={image} onReset={reset} />
                    )}

                    {error && (
                    <div className="fixed bottom-8 left-1/2 -translate-x-1/2 w-full max-w-md px-4 z-[70]">
                        <div className="bg-red-500 text-white p-4 rounded-2xl shadow-xl flex items-center justify-between gap-3 animate-in slide-in-from-bottom-5 fade-in">
                        <p className="font-medium text-sm">{error}</p>
                        <button onClick={() => setError(null)}><XIcon size={18} /></button>
                        </div>
                    </div>
                    )}

                    <canvas ref={canvasRef} className="hidden" />
                </main>

                {/* Footer */}
                <footer className="py-8 border-t border-slate-200 mt-auto">
                    <div className="max-w-4xl mx-auto px-4 text-center">
                    <p className="text-slate-400 text-xs">
                        © 2024 SkinWise AI. AI 분석 결과는 참고용이며 의학적 진단을 대신할 수 없습니다.<br/>
                        정확한 진단은 피부과 전문의와 상담하세요.
                    </p>
                    </div>
                </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>